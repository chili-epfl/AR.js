<!doctype html>
<html>
<head>
    <script type="text/javascript" src="jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="three.min.js"></script>
    <script type="text/javascript" src="ColladaLoader.js"></script>
    <script src="JSARToolKit/NyAs3Utils.js"></script>
    <script src="JSARToolKit/FLARArrayUtil.js"></script>
    <script src="JSARToolKit/FLARException.js"></script>
    <script src="JSARToolKit/FLARMat.js"></script>
    <script src="JSARToolKit/FLARRgbPixelReader.js"></script>
    <script src="JSARToolKit/NyARHistogramAnalyzer.js"></script>
    <script src="JSARToolKit/NyARPca2d.js"></script>
    <script src="JSARToolKit/NyARRasterReader.js"></script>
    <script src="JSARToolKit/NyARTypes.js"></script>
    <script src="JSARToolKit/FLARRasterFilter.js"></script>
    <script src="JSARToolKit/FLARTypes.js"></script>
    <script src="JSARToolKit/NyARLabel.js"></script>
    <script src="JSARToolKit/FLARLabeling.js"></script>
    <script src="JSARToolKit/NyARParam.js"></script>
    <script src="JSARToolKit/FLARParam.js"></script>
    <script src="JSARToolKit/NyARRaster.js"></script>
    <script src="JSARToolKit/FLARRaster.js"></script>
    <script src="JSARToolKit/NyARCode.js"></script>
    <script src="JSARToolKit/FLARCode.js"></script>
    <script src="JSARToolKit/NyARMatch.js"></script>
    <script src="JSARToolKit/NyARRasterAnalyzer.js"></script>
    <script src="JSARToolKit/FLARRasterAnalyzer.js"></script>
    <script src="JSARToolKit/NyARRasterFilter.js"></script>
    <script src="JSARToolKit/NyARSquareDetect.js"></script>
    <script src="JSARToolKit/FLARSquareDetect.js"></script>
    <script src="JSARToolKit/NyARTransMat.js"></script>
    <script src="JSARToolKit/FLARTransMat.js"></script>
    <script src="JSARToolKit/NyARUtils.js"></script>
    <script src="JSARToolKit/NyARIdMarker.js"></script>
    <script src="JSARToolKit/NyARPickup.js"></script>
    <script src="JSARToolKit/FLARProcessor.js"></script>
    <script src="JSARToolKit/NyARDetector.js"></script>
    <script src="JSARToolKit/FLARDetector.js"></script>
    <script src="JSARToolKit/FLARIdMarkerDetector.js"></script>
    <script src="JSARToolKit/NyARSingleMarkerProcesser.js"></script>
    <script src="JSARToolKit/NyUtils.js"></script>

    <style type="text/css">
        body {
            margin:0;
            padding:0;
        }
        .fullscreen {
            position:absolute;
            width:100%;
            height:100%;
            left:0%;
            top:0%;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100px;
            text-align: center;
            z-index: 100;
            display:block;
            color: #ffffff;
            text-shadow: 0px -1px 0px #000000,
               1px  0px 0px #000000,
               0px  1px 0px #000000,
              -1px  0px 0px #000000;
        }
    </style>
</head>

<body>
    <video id="webcam" class="fullscreen" style="display:none;" autoplay ></video>
    <canvas id="videoCanvas" class="fullscreen" style="display:none;" ></canvas>
    <canvas id="dataCanvas" class="fullscreen"  style="display:none;" ></canvas>
    <div id="renderer" class="fullscreen" ></div>
    <div id="info"></div>
    <canvas id="debugCanvas" width="640" height="480"></canvas>
</body>

<script>
DEBUG = true;
var video = document.getElementById('webcam');
var videoCanvas = document.getElementById('videoCanvas');
var canvas = document.getElementById('dataCanvas');
var videoCtx = videoCanvas.getContext('2d');
var ctx = canvas.getContext('2d');
var width = canvas.width;
var height = canvas.height;
var localMediaStream = null;

var info = document.getElementById('info');
var textNode = document.createTextNode('');
info.appendChild(textNode);

function expandCanvas(){
    var b = document.body;
    var d = document.documentElement;
    canvas.height = Math.max(b.clientHeight , b.scrollHeight, d.scrollHeight, d.clientHeight);
    canvas.width = canvas.height * 3 / 2;
    videoCanvas.width = canvas.width;
    videoCanvas.height = canvas.height;
    width = canvas.width;
    height = canvas.height;
}

expandCanvas();

//Checking if webcam is available
var hasGetUserMedia = function() {
    return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

//Error
var onFailSoHard = function(e) {
    console.log('Error!', e);
};

if (hasGetUserMedia()) {
    console.log("Camera OK");
} else {
    alert("Not supporting WebRTC");
}

window.URL = window.URL || window.webkitURL;
navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

navigator.getUserMedia({video: true}, function(stream) {
        video.src = window.URL.createObjectURL(stream);
        localMediaStream = stream;
        }, onFailSoHard);

function copyMarkerMatrix(arMat, glMat) {
    glMat[0] = arMat.m00;
    glMat[1] = -arMat.m10;
    glMat[2] = arMat.m20;
    glMat[3] = 0;
    glMat[4] = arMat.m01;
    glMat[5] = -arMat.m11;
    glMat[6] = arMat.m21;
    glMat[7] = 0;
    glMat[8] = -arMat.m02;
    glMat[9] = arMat.m12;
    glMat[10] = -arMat.m22;
    glMat[11] = 0;
    glMat[12] = arMat.m03;
    glMat[13] = -arMat.m13;
    glMat[14] = arMat.m23;
    glMat[15] = 1;
}

THREE.Matrix4.prototype.setFromArray = function(m) {
    return this.set(
        m[0], m[4], m[8], m[12],
        m[1], m[5], m[9], m[13],
        m[2], m[6], m[10], m[14],
        m[3], m[7], m[11], m[15]
    );
};

var projector = new THREE.Projector();
function toCanvasXYCoords(pos, cam) {
    var vector = projector.projectVector(pos.clone(), cam);
    vector.x = (vector.x + 1)/2 * width + ((window.innerWidth - width)/2);
    vector.y = -(vector.y - 1)/2 * height;
    return vector;
}

//TODO: multiple mode
var markers = {};
function detect(mat) {
    var detectedMarkers = detector.detectMarkerLite(raster, threshold);
    
    var resultMat = new NyARTransMatResult();
    for(var i=0; i<detectedMarkers; i++){
        
        var id = detector.getIdMarkerData(i);
        var currentId = -1;
        if(id.packetLength <= 4){
            currentId = 0;
            for(var j=0; j<id.packetLength; j++){
                currentId = (currentId << 8) | id.getPacketData(j);
                console.log("id[" + j + "]=" + id.getPacketData(j));
            }
        }
        
        console.log("[add] : ID = " + currentId);
        if(markers[currentId] == null){
            markers[currentId] = {};
        }
        
        detector.getTransformMatrix(i, resultMat);
        copyMarkerMatrix(resultMat, mat);
        markers[currentId].age = 0;
        markers[currentId].transform = Object.asCopy(mat);
        
    }
}

//Setup three.js
var renderer;
function initThreeJs() {
    var rendererWidth = width;
    var rendererHeight = height;
    renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(rendererWidth, rendererHeight);
    renderer.domElement.style.position = "absolute";
    renderer.domElement.style.left = "50%";
    renderer.domElement.style.marginLeft = (-width/2) + "px";
    document.getElementById('renderer').appendChild(renderer.domElement);
    renderer.setClearColor(new THREE.Color(0x444444), 1.0);
}

//Setup main scene
var scene;
var camera;
var markerRoot;
var thymio;
function initObjectScene() {
    scene = new THREE.Scene();
    camera = new THREE.Camera();
    
    //Camera setting
    var tmp = new Float32Array(16);
    param.copyCameraMatrix(tmp, 10, 10000);
    camera.projectionMatrix.setFromArray(tmp);
    scene.add(camera);
    
    //Light setting
    light = new THREE.DirectionalLight(0xFFFFFF, 1.0, 0);
    light.position.set( 200, 100, 200 );
    scene.add(light);

    light_ambient = new THREE.AmbientLight(0xFFFFFF);
    scene.add(light_ambient);
    
    //Initialize object
    markerRoot = new THREE.Object3D();
    markerRoot.matrixAutoUpdate = false;
    
    var loader = new THREE.ColladaLoader();
	loader.load( './thymio.dae', function colladaReady( collada ) { 
	thymio = collada.scene.getChildByName( 'Thymio', true ); 
	    thymio.flipSided = false; 
	    thymio.material.transparent = true;
	    thymio.rotation.z = Math.PI;
	    thymio.scale.set(1,1,1);
	    
	    markerRoot.add(collada.scene); 
    } );
    
    scene.add(markerRoot);
    // console.log("success init ObjectScene");
}

//Setup videoTexture
var videoScene;
var videoCam;
var videoTexture;
function initVideoScene() {
    videoScene = new THREE.Scene();
    videoCam = new THREE.OrthographicCamera(-width/2, width/2, height/2, -height/2, 1, 100);
    videoCam.position.x = 0;
    videoCam.position.y = 0;
    videoCam.position.z = 50;
    videoCam.lookAt({x:0, y:0, z:0});
    
    videoTexture = new THREE.Texture(videoCanvas);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    var plane = new THREE.Mesh(new THREE.PlaneGeometry(width, height, 1, 1), new THREE.MeshBasicMaterial({map: videoTexture, overdraw: true, side:THREE.DoubleSide}));
    plane.position.x = 0;
    plane.position.y = 0;
    plane.material.depthTest = false;
    plane.material.depthWrite = false;
    
    videoScene.add(plane);
    videoScene.add(videoCam);
    // console.log("success init videoScene");
}

var maxAge = 5;
var cubes = {};
function updateTransform(){
    for(var i in markers){
        var r = markers[i];
        if(r.age > maxAge) delete markers[i];
        r.age++;
    }

    for(var i in cubes) cubes[i].children[0].visible = false;
    for(var i in markers){
        if(i != 64){
            if(!cubes[i]){
                var root = new THREE.Object3D();
                root.matrixAutoUpdate = false;
                var c = new THREE.Mesh(new THREE.CubeGeometry(100, 100, 100), new THREE.MeshBasicMaterial({color: 0x444444}));
                c.position.z = -50;
                root.add(c);
                scene.add(root);
                cubes[i] = root;
            }
            cubes[i].matrix.setFromArray(markers[i].transform);
            cubes[i].matrixWorldNeedsUpdate = true;
            cubes[i].children[0].visible = true;
        }
    }

    for(var i in thymio) thymio.visible = false;
    if(markers[64] != null){
        for(var i in thymio) thymio.visible = true;
        markerRoot.matrix.setFromArray(markers[64].transform);
        markerRoot.matrixWorldNeedsUpdate = true;
    }
    camera.updateMatrixWorld();
    var pos = new THREE.Vector3();
    var vec = toCanvasXYCoords(pos.getPositionFromMatrix(markerRoot.matrixWorld), camera);
    // console.log("(" + vec.x + "," + vec.y + "," + vec.z + ")");
    info.style.left = (vec.x - 50) + 'px';
    info.style.top = (vec.y - 100) + 'px';
    var text = '(' + vec.x.toFixed(1) + ', ' + vec.y.toFixed(1) + ')';
    textNode.nodeValue = text;
}

//Main loop
function loop(){
    //Video scene
    videoCtx.drawImage(video, 0, 0, width, height);
    videoTexture.needsUpdate = true;
    
    //Object scene
    ctx.drawImage(videoCanvas, 0, 0, width, height);
    canvas.changed = true;
    var detectedArray = new Float32Array(16);
    detect(detectedArray);
    updateTransform();
    
    //Render the scene
    renderer.autoClear = false;
    renderer.clear();
    renderer.render(videoScene, videoCam);
    renderer.render(scene, camera);
    window.requestAnimationFrame(loop);
}

var raster;
var param;
var detector;
var threshold = 140;
window.onload = function() {
    //Initialize ARToolKit
    raster = new NyARRgbRaster_Canvas2D(canvas);
    param = new FLARParam(width, height);
    detector = new FLARMultiIdMarkerDetector(param, 120);
    detector.setContinueMode(true);
    //param.copyCameraMatrix(display.camera.perspectiveMatrix, 10, 10000);
    console.log("success");
    
    //Initialize Three.js
    initThreeJs();
    
    //Setup 3D Object
    initObjectScene();
    
    //Setup videoTexture
    initVideoScene();
    
    //animation
    loop();
};

</script>

</html>
